<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Crypto Earning App</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, #0d0d1a, #1c1c3c);
  color: #fff;
  transition: background 0.3s ease;
}
#app {
  max-width: 500px;
  margin: 0 auto;
  padding-bottom: 120px;
}

/* উন্নত ও সুন্দর হেডার ডিজাইন */
header {
  background: linear-gradient(135deg, #6a11cb, #2575fc);
  padding: 20px 15px;
  display: flex;
  align-items: center; /* বাম পাশে আইকন রাখার জন্য */
  justify-content: flex-start;
  border-radius: 0 0 25px 25px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
  position: relative;
}

/* বাম কোণায় কার্টুন প্রোফাইল পিক */
.profile-avatar {
  width: 50px;
  height: 50px;
  background: #fff;
  border-radius: 50%;
  margin-right: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border: 2px solid #ffeb3b;
}
.profile-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.header-info {
  display: flex;
  flex-direction: column;
}
header h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  letter-spacing: 0.5px;
}
header p {
  margin: 4px 0 0;
  color: #ffeb3b;
  font-weight: 600;
  font-size: 15px;
}

.page {
  display: none;
  padding: 15px;
  animation: fadeIn 0.45s ease-in-out;
}
.page.active {
  display: block;
}
h2 {
  margin-top: 10px;
  color: #ff9800;
  font-weight: 700;
  text-align: center;
  margin-bottom: 20px;
}
.box {
  background: linear-gradient(135deg, #1e1e2e, #292949);
  padding: 16px;
  border-radius: 14px;
  margin-bottom: 15px;
  border: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.45);
  transition: transform 0.25s ease;
}
.box:hover {
  transform: translateY(-3px);
}
.box h3 { margin: 0 0 8px; font-size: 16px; color: #ffd79b; }

.stat-row { display:flex; justify-content:space-between; gap:10px; margin-bottom:12px; }
.stat {
  background: rgba(255,255,255,0.05);
  padding:10px;
  border-radius:12px;
  flex: 1;
  text-align:center;
}
.stat b { display:block; font-size:18px; color:#fff; }
.stat small { color:#cfcfcf; font-size: 11px; }

.action-btn {
  display:block; width:100%; padding:12px;
  background:linear-gradient(135deg,#ff416c,#ff4b2b);
  color:#fff; border:0; border-radius:10px;
  font-weight:700; margin-top:8px;
  cursor:pointer; transition: 0.2s;
}
.action-btn.secondary { background: linear-gradient(135deg,#2193b0,#6dd5ed); }
.action-btn:active { transform: scale(0.98); }

input, select {
  width:100%; padding:12px; border-radius:10px; box-sizing: border-box;
  border:1px solid #444; background:#26263f; color:#fff; margin-top:8px;
}

#notice-popup {
  display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%);
  background:#2b2f4a; color:#fff; padding:12px 20px; border-radius:30px;
  z-index:2000; box-shadow:0 8px 30px rgba(0,0,0,0.6); font-size: 14px;
}

.bottom-nav {
  position:fixed; bottom:0; left:0; right:0;
  max-width:500px; margin:0 auto; display:flex;
  background:#1e1e2e; border-top:1px solid #333;
  border-radius:20px 20px 0 0; z-index:100;
}
.bottom-nav button {
  flex:1; padding:12px 6px; border:0; background:none; color:#aaa;
  display:flex; flex-direction:column; align-items:center; font-size:12px; gap:4px;
}
.bottom-nav button.active { color:#ff9800; }

.footer {
  background:#1e1e2e; padding:8px 0; font-size:13px; color:#ff9800;
  position:fixed; bottom:56px; left:0; right:0; max-width:500px; margin:0 auto;
  overflow:hidden; z-index:90; border-top: 1px solid #333;
}
.footer-text { display:inline-block; white-space:nowrap; animation:scroll-left 15s linear infinite; }

#loading-modal {
  display:none; position:fixed; left:0; top:0; width:100%; height:100%;
  background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1500;
}

@keyframes scroll-left { 0% {transform:translateX(100%);} 100% {transform:translateX(-100%);} }
@keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
</style>
</head>
<body>

<div id="app">
  <header>
    <div class="profile-avatar">
      <img src="https://img.icons8.com/bubbles/100/000000/user-male.png" alt="User">
    </div>
    <div class="header-info">
      <h1 id="user-name">Loading...</h1>
      <p>Balance: <span id="user-points">0</span></p>
    </div>
  </header>

  <main>
    <div id="home-page" class="page active">
      <h2>Dashboard</h2>
      <div class="box">
        <div class="stat-row">
          <div class="stat"><small>Daily Ads</small><b><span id="daily-ads-watched">0</span>/<span id="daily-limit">120</span></b></div>
          <div class="stat"><small>Referrals</small><b id="referral-count">0</b></div>
          <div class="stat"><small>Points</small><b id="user-points-compact">0</b></div>
        </div>
        <label style="font-size: 13px; color: #aaa;">Your Referral Link</label>
        <input id="referral-link" readonly />
        <button id="copy-ref-link-btn" class="action-btn secondary">Copy Referral Link</button>
      </div>
    </div>

    <div id="tasks-page" class="page">
      <h2>Tasks</h2>
      <div class="box">
        <h3>Watch Video Ad</h3>
        <p style="font-size: 14px;">Earn <span id="points-per-ad">20</span> points instantly</p>
        <button id="watch-ad-btn" class="action-btn">Watch Ad Now</button>
      </div>
      <div class="box">
        <h3>Official Channel</h3>
        <p id="channel-status" style="font-size: 14px;">Join & claim your hourly bonus</p>
        <button id="join-channel-btn" class="action-btn">Join & Claim</button>
      </div>
      <div class="box">
        <h3>Community Group</h3>
        <p id="group-status" style="font-size: 14px;">Stay updated to claim bonus</p>
        <button id="join-group-btn" class="action-btn">Join & Claim</button>
      </div>
    </div>

    <div id="withdraw-page" class="page">
      <h2>Withdraw</h2>
      <div class="box">
        <p style="text-align: center; color: #ffeb3b;">Minimum: <span id="min-withdraw">8000</span> <span id="currency">BDT</span></p>
        <form id="withdraw-form">
          <label>Payment Method</label>
          <select id="payment-method" required></select>
          <label>Account Number</label>
          <input id="account-number" required placeholder="017xxxxxxxx"/>
          <label>Amount</label>
          <input id="amount" type="number" required placeholder="Enter amount"/>
          <button id="withdraw-submit-btn" class="action-btn">Submit Request</button>
        </form>
      </div>
      <div class="box">
        <h3>History</h3>
        <div id="withdraw-history"></div>
      </div>
    </div>

    <div id="notice-page" class="page">
      <h2>Notices</h2>
      <div id="notice-list" class="box"></div>
    </div>
  </main>

  <div id="notice-popup"></div>
  <div class="footer"><div class="footer-text">Developed by Crypto Earning Lab MD JABED AHMED — Stay safe, enjoy earning!</div></div>

  <nav class="bottom-nav">
    <button class="active" data-page="home-page"><i class="fas fa-home"></i> Home</button>
    <button data-page="tasks-page"><i class="fas fa-tasks"></i> Tasks</button>
    <button data-page="withdraw-page"><i class="fas fa-wallet"></i> Withdraw</button>
    <button data-page="notice-page"><i class="fas fa-bell"></i> Notices</button>
  </nav>
</div>

<div id="loading-modal"><div class="modal-content">Loading Ad...</div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script id="adexora-script"></script>

<script>
/* ====== FIREBASE CONFIG ====== */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDI_FfOYRvV0p2YfZyoGEN4XYzg3zTgVUQ",
  authDomain: "test-47a41.firebaseapp.com",
  databaseURL: "https://test-47a41-default-rtdb.firebaseio.com",
  projectId: "test-47a41",
  storageBucket: "test-47a41.firebasestorage.app",
  messagingSenderId: "1000979567428",
  appId: "1:1000979567428:web:3e405f179366a8ef7ebd11"
};
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

let appConfig = {};
let userState = {
  points: 0, dailyAdWatchCount: 0, lastAdWatchDate: null, referralCount: 0,
  userId: null, username: null, lastChannelClaim: 0, lastGroupClaim: 0
};

function toast(m){
  const b = document.getElementById('notice-popup');
  b.innerText = m; b.style.display = 'block';
  setTimeout(()=>{ b.style.display = 'none'; }, 3500);
}

/* UID & Referral logic */
async function buildUid(){
  try{
    const tg = window.Telegram?.WebApp?.initDataUnsafe || window.Telegram?.WebApp?.initData;
    if(tg?.user){
      const uid = "tg_" + tg.user.id;
      userState.username = tg.user.first_name;
      const startParam = tg.start_param || new URLSearchParams(window.location.search).get('start');
      if(startParam && startParam.startsWith("ref_")){
        const refId = startParam.replace("ref_","");
        if(refId && refId !== uid){
          const refSnap = await db.ref("/users/" + refId).once("value");
          if(refSnap.exists()){
            const refUser = refSnap.val();
            refUser.referralCount = (refUser.referralCount || 0) + 1;
            await db.ref("/users/" + refId).set(refUser);
          }
        }
      }
      return uid;
    }
  }catch(e){}
  if(!localStorage.uid) localStorage.uid = "guest_" + Date.now();
  return localStorage.uid;
}

function updateUI(){
  document.getElementById('user-name').textContent = userState.username || "Crypto Earning Lab";
  document.getElementById("user-points").textContent = userState.points || 0;
  const compact = document.getElementById("user-points-compact");
  if(compact) compact.textContent = userState.points || 0;
  document.getElementById("daily-ads-watched").textContent = userState.dailyAdWatchCount || 0;
  document.getElementById("referral-count").textContent = userState.referralCount || 0;
  
  const botUsername = appConfig.BOT_USERNAME || "your_bot";
  const ref = document.getElementById("referral-link");
  if(ref){
    ref.value = userState.userId ? `https://t.me/${botUsername}?start=ref_${userState.userId}` : `https://t.me/${botUsername}`;
  }
}

/* ডাইনামিক এডস স্ক্রিপ্ট লোডার */
function loadAdScript(adId) {
  if(!adId) return;
  const oldScript = document.getElementById('adexora-script');
  const newScript = document.createElement('script');
  newScript.id = 'adexora-script';
  newScript.src = `https://adexora.com/cdn/ads.js?id=${adId}`;
  oldScript.parentNode.replaceChild(newScript, oldScript);
}

db.ref("/appConfig").on("value", s=>{
  const v = s.val();
  if(!v) return;
  appConfig = v;
  
  // ডাইনামিক এড আইডি সেটআপ
  if(appConfig.ADEXORA_ID) {
    loadAdScript(appConfig.ADEXORA_ID);
  }

  if(appConfig.APP_COLOR) document.body.style.background = appConfig.APP_COLOR;
  document.getElementById("daily-limit").textContent = appConfig.DAILY_AD_LIMIT || 120;
  document.getElementById("points-per-ad").textContent = appConfig.POINTS_PER_AD || 20;
  document.getElementById("min-withdraw").textContent = appConfig.MIN_WITHDRAW_POINTS || 8000;
  document.getElementById("currency").textContent = appConfig.CURRENCY || "BDT";
  
  const pm = document.getElementById("payment-method");
  if(pm){
    pm.innerHTML = "";
    (appConfig.PAYMENT_METHODS || ["Bkash","Nagad"]).forEach(m=>{
      const o = document.createElement("option");
      o.value = m; o.textContent = m; pm.appendChild(o);
    });
  }
  updateUI();
});

(async()=>{
  const uid = await buildUid();
  userState.userId = uid;
  const s = await db.ref("/users/" + uid).once("value");
  if(s.exists()){
    userState = {...userState, ...s.val()};
  } else {
    userState.lastAdWatchDate = new Date().toISOString().slice(0,10);
    await db.ref("/users/" + uid).set(userState);
  }
  db.ref("/users/" + uid).on("value", d=>{
    if(d.exists()){
      userState = {...userState, ...d.val()};
      updateUI();
    }
  });
  updateUI();
})();

/* Navigation */
document.querySelectorAll(".bottom-nav button").forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    document.getElementById(b.dataset.page).classList.add("active");
    document.querySelectorAll(".bottom-nav button").forEach(bb=>bb.classList.remove("active"));
    b.classList.add("active");
  };
});

document.getElementById("copy-ref-link-btn").onclick = ()=>{
  const t = document.getElementById("referral-link").value;
  navigator.clipboard.writeText(t).then(()=>toast("Referral link copied!")).catch(()=>toast("Copy failed"));
};

/* -------- আপডেট করা ডাইনামিক এডস ফাংশন -------- */
document.getElementById("watch-ad-btn").onclick = async ()=>{
  // চেক এডমিন আইডি
  if(!appConfig.ADEXORA_ID){
    return toast("Warning: Ad ID not set in Admin Panel!");
  }

  const today = new Date().toISOString().slice(0,10);
  if(userState.lastAdWatchDate !== today){
    userState.dailyAdWatchCount = 0;
    userState.lastAdWatchDate = today;
  }

  const limit = appConfig.DAILY_AD_LIMIT || 120;
  if(userState.dailyAdWatchCount >= limit) return toast("Daily limit reached!");

  if(typeof window.showAdexora === "function"){
    document.getElementById("loading-modal").style.display = "flex";
    
    // আপনার দেওয়া নতুন প্রমিজ সিস্টেম
    window.showAdexora()
      .then(async () => {
        // ✅ Reward Logic
        const pts = parseInt(appConfig.POINTS_PER_AD || 20, 10);
        userState.points += pts;
        userState.dailyAdWatchCount++;
        await db.ref("/users/" + userState.userId).set(userState);
        toast("Success! +" + pts + " points");
        document.getElementById("loading-modal").style.display = "none";
      })
      .catch(e => {
        // ❌ Error Logic
        toast("Ad closed or failed to load");
        document.getElementById("loading-modal").style.display = "none";
      });

  } else {
    toast("Ads loading... please wait a moment.");
  }
};

/* Hourly Claims */
function updateCountdownDisplays(){
  const now = Date.now();
  const chBtn = document.getElementById("join-channel-btn");
  const grBtn = document.getElementById("join-group-btn");
  
  const channelLeft = Math.max(0, 3600000 - (now - (userState.lastChannelClaim || 0)));
  const groupLeft = Math.max(0, 3600000 - (now - (userState.lastGroupClaim || 0)));

  if(chBtn){
    if(channelLeft > 0){
      chBtn.disabled = true;
      document.getElementById("channel-status").textContent = `Wait: ${Math.floor(channelLeft/60000)}m ${Math.floor((channelLeft%60000)/1000)}s`;
    } else {
      chBtn.disabled = false;
      document.getElementById("channel-status").textContent = "Claim your hourly channel bonus";
    }
  }
  if(grBtn){
    if(groupLeft > 0){
      grBtn.disabled = true;
      document.getElementById("group-status").textContent = `Wait: ${Math.floor(groupLeft/60000)}m ${Math.floor((groupLeft%60000)/1000)}s`;
    } else {
      grBtn.disabled = false;
      document.getElementById("group-status").textContent = "Claim your hourly group bonus";
    }
  }
}
setInterval(updateCountdownDisplays, 1000);

document.getElementById("join-channel-btn").onclick = async ()=>{
  const link = appConfig.CHANNEL_LINK || appConfig.CHANNEL_URL;
  if(!link) return toast("Link not available");
  window.open(link, "_blank");
  
  const now = Date.now();
  if(now - (userState.lastChannelClaim || 0) < 3600000) return;

  const bonus = parseInt(appConfig.CHANNEL_JOIN_BONUS || 100, 10);
  userState.points += bonus;
  userState.lastChannelClaim = now;
  await db.ref("/users/" + userState.userId).set(userState);
  toast(`Bonus Claimed! +${bonus}`);
};

document.getElementById("join-group-btn").onclick = async ()=>{
  const link = appConfig.GROUP_LINK || appConfig.GROUP_URL;
  if(!link) return toast("Link not available");
  window.open(link, "_blank");
  
  const now = Date.now();
  if(now - (userState.lastGroupClaim || 0) < 3600000) return;

  const bonus = parseInt(appConfig.GROUP_JOIN_BONUS || 100, 10);
  userState.points += bonus;
  userState.lastGroupClaim = now;
  await db.ref("/users/" + userState.userId).set(userState);
  toast(`Bonus Claimed! +${bonus}`);
};

/* Withdraw */
document.getElementById("withdraw-form").onsubmit = async e=>{
  e.preventDefault();
  const method = document.getElementById("payment-method").value;
  const acc = document.getElementById("account-number").value.trim();
  const amt = parseInt(document.getElementById("amount").value, 10);
  const min = parseInt(appConfig.MIN_WITHDRAW_POINTS || 8000, 10);

  if(amt < min) return toast("Minimum withdraw is " + min);
  if(amt > userState.points) return toast("Insufficient balance");

  userState.points -= amt;
  await db.ref("/users/" + userState.userId).set(userState);

  const r = db.ref("/withdrawRequests").push();
  const payload = {
    id: r.key, userId: userState.userId, username: userState.username,
    method, account: acc, amount: amt, status: "pending", createdAt: new Date().toISOString()
  };
  await r.set(payload);
  
  try { await db.ref("/admin/newWithdrawRequests/" + r.key).set(payload); } catch(e){}

  toast("Withdrawal submitted!");
  e.target.reset();
};

function loadWithdrawHistory() {
  db.ref("/withdrawRequests").orderByChild("userId").equalTo(userState.userId).on("value", snap => {
    const list = document.getElementById("withdraw-history");
    list.innerHTML = "";
    snap.forEach(item => {
      const d = item.val();
      const div = document.createElement("div");
      div.style.background = "rgba(255,255,255,0.03)";
      div.style.padding = "10px"; div.style.borderRadius = "8px"; div.style.marginBottom = "8px";
      div.innerHTML = `<strong>${d.amount} ${appConfig.CURRENCY || 'BDT'}</strong> - ${d.status} <br><small>${new Date(d.createdAt).toLocaleDateString()}</small>`;
      list.prepend(div);
    });
  });
}
setTimeout(loadWithdrawHistory, 2000);

/* Real-time Notice */
db.ref("/notice").on("value", snap => {
  const d = snap.val();
  if (d && d.message) {
    toast(d.message);
    const list = document.getElementById("notice-list");
    const item = document.createElement("div");
    item.style.padding = "10px"; item.style.borderBottom = "1px solid #333";
    item.innerHTML = `<strong>${d.message}</strong>`;
    list.prepend(item);
  }
});

setInterval(() => updateUI(), 3000);
</script>
</body>
</html>